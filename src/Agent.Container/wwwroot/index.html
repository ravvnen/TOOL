<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agent Chat</title>
  <style>
    :root { --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --card:#111827; --accent:#22d3ee; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
           background:var(--bg); color:var(--fg); }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    .row{ display:flex; gap:16px; align-items:center; }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .pill{ padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:var(--muted); }
    .muted{ color:var(--muted); }
    .input{ width:100%; padding:14px 16px; border-radius:12px; border:1px solid #1f2937; background:#0b1220; color:var(--fg); }
    .btn{ background:linear-gradient(90deg,#22d3ee,#a78bfa); color:#0a0a0a; padding:12px 16px; border-radius:12px; border:none; font-weight:700; cursor:pointer; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .chat{ display:flex; flex-direction:column; gap:12px; }
    .bubble{ padding:12px 14px; border-radius:14px; max-width:80%; }
    .me{ align-self:flex-end; background:#1f2937; }
    .bot{ align-self:flex-start; background:#0b1220; border:1px solid #1f2937; }
    .rule{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
           background:#0b1220; border:1px solid #1f2937; padding:8px; border-radius:10px; white-space:pre-wrap; }
    .grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .tag{ display:inline-block; padding:2px 6px; font-size:12px; border:1px solid #1f2937; border-radius:999px; color:var(--muted); margin-right:6px; }
    .tabs{ display:flex; gap:8px; margin:12px 0; }
    .tab{ padding:8px 12px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; cursor:pointer; }
    .tab.active{ border-color:#22d3ee; color:#22d3ee; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid #1f2937; vertical-align:top; }
    th{ color:var(--muted); font-weight:600; }
    code.small{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .empty{ color:var(--muted); padding:8px 0; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <!-- React + Babel (needed because we use JSX here) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    function useApi() {
      const get = async (url) => {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      };
      const post = async (url, data) => {
        const r = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      };
      return { get, post };
    }

    function TopBar() {
      const [state, setState] = React.useState(null);
      const api = useApi();

      const load = async () => setState(await api.get('/debug/status'));
      React.useEffect(()=>{ load(); const t=setInterval(load, 3000); return ()=>clearInterval(t); }, []);

      const color = (state?.state === 'Ready') ? '#10b981' :
                    (state?.state === 'Connecting') ? '#f59e0b' :
                    (state?.state === 'Degraded') ? '#f59e0b' : '#ef4444';

      return (
        <div className="row" style={{justifyContent:'space-between', marginBottom:16}}>
          <div className="row" style={{gap:8, alignItems:'center'}}>
            <div className="pill" style={{borderColor:color, color}}>
              {state?.state ?? '—'}{state?.details?.ns ? ` · ${state.details.ns}` : ''}
            </div>
            {state?.details?.db && <div className="pill">DB: {state.details.db}</div>}
            {state?.details?.nats && <div className="pill">NATS: {state.details.nats}</div>}
            {state?.details?.durable && <div className="pill">Durable: {state.details.durable}</div>}
          </div>
          <div className="muted" title={state?.message}>{state?.message ?? '—'}</div>
        </div>
      );
    }

    function SearchPanel({onInsert}) {
      const api = useApi();
      const [q, setQ] = useState("");
      const [res, setRes] = useState([]);
      const search = async () => {
        if (!q) return;
        const r = await api.get(`/search?q=${encodeURIComponent(q)}&k=12`);
        setRes(r);
      };
      return (
        <div className="card" style={{marginTop:12}}>
          <div className="row">
            <input className="input" placeholder="Search rules (FTS or LIKE)…" value={q} onChange={e=>setQ(e.target.value)} />
            <button className="btn" onClick={search}>Search</button>
          </div>
          <div className="grid" style={{marginTop:12}}>
            {res.map((r,i)=>
              <div key={i} className="card">
                <div style={{fontWeight:700, marginBottom:6}}>
                  {r.title} <span className="tag">{r.item_id}@v{r.version}</span>
                </div>
                <div className="rule" style={{maxHeight:120, overflow:'auto'}}>{r.content}</div>
                <div style={{marginTop:8}}>
                  <button className="btn" onClick={()=>onInsert(r)}>Insert into chat</button>
                </div>
              </div>
            )}
            {res.length===0 && <div className="empty">No results yet. Try a query like <code className="small">http timeout</code>.</div>}
          </div>
        </div>
      );
    }

    function DebugPanel() {
      const api = useApi();
      const [items, setItems] = useState([]);
      const [selected, setSelected] = useState(null);
      const load = async () => setItems(await api.get('/debug/items'));
      const open = async (id) => setSelected(await api.get(`/debug/item/${encodeURIComponent(id)}`));
      useEffect(()=>{ load(); }, []);

      return (
        <div className="card" style={{marginTop:12}}>
          <div className="row" style={{justifyContent:'space-between'}}>
            <div style={{fontWeight:700}}>Agent DB — Current Items</div>
            <button className="btn" onClick={load}>Refresh</button>
          </div>

          <div style={{overflow:'auto', marginTop:8}}>
            <table style={{width:'100%'}}>
              <thead>
                <tr>
                  <th>Item</th><th>Version</th><th>Title</th><th>Active</th>
                  <th>Preview</th><th>Labels</th><th>Occurred</th><th>Emitted</th><th></th>
                </tr>
              </thead>
              <tbody>
                {items.map((r,i)=>(
                  <tr key={i}>
                    <td><code className="small">{r.item_id}</code></td>
                    <td>{r.version}</td>
                    <td>{r.title}</td>
                    <td>{r.is_active ? '✅' : '—'}</td>
                    <td><code className="small">{r.preview}</code></td>
                    <td><code className="small">{r.labels_json}</code></td>
                    <td><span className="muted">{r.occurred_at}</span></td>
                    <td><span className="muted">{r.emitted_at}</span></td>
                    <td><button className="btn" onClick={()=>open(r.item_id)}>Open</button></td>
                  </tr>
                ))}
                {items.length===0 && (
                  <tr><td colSpan="9" className="empty">
                    No items in the local DB. Check that your agent is subscribed to the correct <b>NS</b> and DELTAS are flowing.
                  </td></tr>
                )}
              </tbody>
            </table>
          </div>

          {selected && (
            <div style={{marginTop:16}}>
              <div style={{fontWeight:700, marginBottom:8}}>Item Detail — {selected.current?.item_id}</div>
              <div className="grid">
                <div className="card">
                  <div style={{fontWeight:700}}>Current</div>
                  <pre className="rule">{JSON.stringify(selected.current, null, 2)}</pre>
                </div>
                <div className="card">
                  <div style={{fontWeight:700}}>Provenance</div>
                  <pre className="rule">{JSON.stringify(selected.provenance, null, 2)}</pre>
                </div>
              </div>
              <div className="card" style={{marginTop:12}}>
                <div style={{fontWeight:700}}>History</div>
                <pre className="rule">{JSON.stringify(selected.history, null, 2)}</pre>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Chat() {
      const api = useApi();
      const [state, setState] = useState(null);
      const [prompt, setPrompt] = useState("");
      const [messages, setMessages] = useState([]);
      const [busy, setBusy] = useState(false);
      const [tab, setTab] = useState('chat');
      const endRef = useRef();

      const refreshState = async () => setState(await api.get('/state'));
      useEffect(()=>{ refreshState(); }, []);
      useEffect(()=>{ endRef.current?.scrollIntoView({behavior:'smooth'}) }, [messages]);

      const send = async () => {
        if (!prompt.trim()) return;
        const myMsg = { role:'user', content: prompt };
        setMessages(m => [...m, myMsg]);
        setBusy(true);
        try {
          const r = await api.post('/v1/chat', { prompt, topK: 6, temperature: 0.2 });
          const body = r?.llm_response?.body ?? r?.llm_response_raw ?? r;
          let content;
          if (typeof body === 'string') content = body;
          else if (body?.choices?.[0]?.message?.content) content = body.choices[0].message.content;
          else content = JSON.stringify(body, null, 2);

          const botMsg = { role:'assistant', content, memory: r.compiled_memory };
          setMessages(m => [...m, botMsg]);
          setPrompt("");
          await refreshState();
        } catch (e) {
          setMessages(m => [...m, { role:'assistant', content: `Error: ${e}` }]);
        } finally { setBusy(false); }
      };

      const insertRule = (r) => {
        setPrompt(p => p + ` [im:${r.item_id}@v${r.version}]`);
      };

      return (
        <>
          <TopBar state={state}/>

          <div className="tabs">
            <div className={`tab ${tab==='chat'?'active':''}`} onClick={()=>setTab('chat')}>Chat</div>
            <div className={`tab ${tab==='debug'?'active':''}`} onClick={()=>setTab('debug')}>Debug DB</div>
          </div>

          {tab === 'chat' ? (
            <>
              <div className="card chat" style={{minHeight:'40vh'}}>
                {messages.map((m, i) => (
                  <div key={i} className={`bubble ${m.role==='user'?'me':'bot'}`}>
                    <div style={{whiteSpace:'pre-wrap'}}>{m.content}</div>
                    {m.memory && (
                      <details style={{marginTop:8}}>
                        <summary className="muted">Show instruction memory injected</summary>
                        <pre className="rule">{JSON.stringify(m.memory, null, 2)}</pre>
                      </details>
                    )}
                  </div>
                ))}
                <div ref={endRef}></div>
              </div>

              <div className="row" style={{marginTop:12}}>
                <textarea className="input" rows="3" placeholder="Ask anything…"
                  value={prompt} onChange={e=>setPrompt(e.target.value)} />
                <button className="btn" onClick={send} disabled={busy}>
                  {busy ? 'Thinking…' : 'Send'}
                </button>
              </div>

              <SearchPanel onInsert={insertRule} />
            </>
          ) : (
            <DebugPanel/>
          )}
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Chat/>);
  </script>
</body>
</html>
