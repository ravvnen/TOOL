@startuml Sequence_Replay
title Sequence Diagram: Replay for Determinism Verification (H3)

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

actor "User" as USER
participant "Agent.UI" as UI
participant "TOOL API\n(ReplayController)" as API
participant "Replay\nEngine" as REPLAY
queue "DELTAS\n(JetStream)" as DELTAS
database "Temp SQLite\n(Fresh DB)" as TEMP_DB
database "Main SQLite\n(Projection)" as MAIN_DB

== User Triggers Replay ==

USER -> UI: Click "Trigger Replay" button
activate UI

UI -> API: POST /api/v1/admin/replay\n{ns: "ravvnen.consulting"}
activate API

API -> REPLAY: ReplayAsync(ns, tempDbPath)
activate REPLAY

== Step 1: Create Fresh Database ==

REPLAY -> TEMP_DB: Create temp file\n/tmp/replay_{guid}.db
REPLAY -> TEMP_DB: CREATE TABLE im_items_current
REPLAY -> TEMP_DB: CREATE TABLE im_items_history
REPLAY -> TEMP_DB: CREATE TABLE source_bindings

note over TEMP_DB: Fresh database with\nempty tables (clean slate)

== Step 2: Create Ephemeral Consumer ==

REPLAY -> DELTAS: CreateConsumer\n{name: "replay-{guid}",\nDeliverPolicy: All,\nFilterSubject: "delta.{ns}.>"}

note right of DELTAS
  Ephemeral consumer:
  - Reads from seq 1
  - No durable state
  - Deleted after replay
end note

== Step 3: Replay All DELTAs ==

loop For each DELTA (seq 1 → N)
    DELTAS -> REPLAY: Fetch DELTA\n{type, item_id, version, content}

    alt type == "im.upsert.v1"
        REPLAY -> TEMP_DB: UPSERT im_items_current
        REPLAY -> TEMP_DB: INSERT im_items_history
        REPLAY -> TEMP_DB: INSERT source_bindings
    else type == "im.retract.v1"
        REPLAY -> TEMP_DB: UPDATE is_active=0
        REPLAY -> TEMP_DB: INSERT im_items_history
    end

    REPLAY -> DELTAS: ACK
end

== Step 4: Compute State Hash ==

REPLAY -> TEMP_DB: SELECT title, content\nFROM im_items_current\nWHERE is_active=1\nORDER BY item_id
TEMP_DB --> REPLAY: rows[]

REPLAY -> REPLAY: Compute SHA256\nof concatenated content

== Step 5: Cleanup ==

REPLAY -> DELTAS: DeleteConsumer("replay-{guid}")
REPLAY -> TEMP_DB: Delete temp file

REPLAY --> API: ReplayResult {\n  eventsProcessed: N,\n  activeRulesCount: 150,\n  imHash: "ABC123...",\n  durationMs: 2300\n}
deactivate REPLAY

API --> UI: 200 OK {ReplayResult}
deactivate API

== Compare with Main Projection ==

UI -> API: GET /api/v1/state?ns=...
API -> MAIN_DB: Compute hash
MAIN_DB --> API: {activeItems, imHash}
API --> UI: StateResponse

UI -> UI: Compare hashes:\nreplay.imHash == state.imHash?

UI --> USER: Display result:\n"✓ SRA = 100%\nState matches!"
deactivate UI

note over USER, MAIN_DB
  **H3 Verification:**
  If replay hash == main hash,
  system is deterministic.

  State Reconstruction Accuracy = 100%
end note

@enduml
