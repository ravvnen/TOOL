@startuml C4_Component
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Component Diagram - TOOL API Internal Structure

Container_Boundary(api, "TOOL API") {

    Component(seedController, "Seed Controller", "ASP.NET Controller", "/api/v1/seed - receives GitHub webhooks, publishes to EVENTS")

    Component(memoryController, "Memory Controller", "ASP.NET Controller", "/api/v1/compile-memory, /state, /search, /why - memory compilation and search")

    Component(agentController, "Agent Controller", "ASP.NET Controller", "/agent/{ns}/memory, /chat, /health, /state - agent-facing endpoints")

    Component(adminController, "Admin Controller", "ASP.NET Controller", "/api/v1/admin/rules - CRUD operations on rules")

    Component(replayController, "Replay Controller", "ASP.NET Controller", "/api/v1/admin/replay - triggers replay")

    Component(memoryCompiler, "Memory Compiler", "Service", "FTS5 search, relevance ranking, JSON formatting for LLM injection")

    Component(seedHandler, "Seed Handler", "Service", "Parses webhook payload, publishes to EVENTS stream")

    Component(promoterService, "Promoter Service", "Background Service", "Subscribes EVENTS, validates, emits DELTAS")

    Component(deltaProjector, "Delta Projector", "Background Service", "Subscribes DELTAS, upserts to SQLite projection")

    Component(replayEngine, "Replay Engine", "Service", "Replays DELTAS from seq 1, rebuilds projection")
}

ContainerDb(nats, "NATS JetStream", "Streams: EVENTS, DELTAS")
ContainerDb(sqlite, "SQLite DB", "im_items_current, im_items_history, source_bindings, im_fts")

' Controller dependencies
Rel(seedController, seedHandler, "Uses")
Rel(memoryController, memoryCompiler, "Uses")
Rel(agentController, memoryCompiler, "Uses")
Rel(replayController, replayEngine, "Uses")

' Seed flow
Rel(seedHandler, nats, "Publishes EVENTS")

' Admin flow
Rel(adminController, nats, "Publishes EVENTS")

' Background services
Rel(promoterService, nats, "Subscribes EVENTS, Publishes DELTAS")
Rel(deltaProjector, nats, "Subscribes DELTAS")
Rel(deltaProjector, sqlite, "Writes projection")

' Query flow
Rel(memoryCompiler, sqlite, "FTS5 search")

' Replay flow
Rel(replayEngine, nats, "Reads DELTAS from seq 1")
Rel(replayEngine, sqlite, "Rebuilds projection")

@enduml
