@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Container Diagram - TOOL System Architecture

Person(user, "User", "Developer/researcher testing the system")

System_Boundary(tool, "TOOL System") {
    Container(agentui, "Agent.UI", "React 19 / Vite", "Frontend for chat, search, state view, admin CRUD, replay trigger. Calls Ollama directly for LLM responses")

    Container(api, "TOOL API", ".NET 9 / ASP.NET Core", "REST API with modules: SeedProcessing, MemoryManagement, AgentOperations, Admin, Replay")

    Container(promoter, "Promoter Service", ".NET Background Service", "Consumes EVENTS, validates, emits DELTAS")

    Container(projector, "Delta Projector", ".NET Background Service", "Consumes DELTAS, updates SQLite projection")

    ContainerDb(sqlite, "Projection DB", "SQLite + FTS5", "Tables: im_items_current, im_items_history, source_bindings. Full-text search via FTS5")
}

System_Ext(nats, "NATS JetStream", "Event streaming with durable streams: EVENTS, DELTAS")
System_Ext(github, "GitHub", "Rule source repository")
System_Ext(ollama, "Ollama", "Local LLM (llama3)")

' User interactions
Rel(user, agentui, "Uses browser", "HTTP :3000")

' Agent.UI interactions
Rel(agentui, api, "compile-memory, search, state, admin CRUD, replay", "HTTP :5293")
Rel(agentui, ollama, "Chat completions with compiled memory", "HTTP :11434")

' GitHub webhook
Rel(github, api, "POST /api/v1/seed", "Webhook")

' Internal TOOL flows
Rel(api, nats, "Publishes to EVENTS stream", "NATS")
Rel(promoter, nats, "Subscribes EVENTS, publishes DELTAS", "NATS")
Rel(projector, nats, "Subscribes DELTAS", "NATS")
Rel(projector, sqlite, "UPSERT rules", "SQL")
Rel(api, sqlite, "FTS5 queries for memory compilation", "SQL")

note right of agentui
  Agent.UI handles LLM calls:
  1. Get compiled memory from TOOL API
  2. Send to Ollama with memory injected
  3. Display response with citations
end note

note bottom of api
  API Modules:
  - /api/v1/seed (GitHub webhooks)
  - /api/v1/compile-memory, /state, /search, /why
  - /api/v1/admin/rules (CRUD)
  - /api/v1/admin/replay
  - /agent/{ns}/memory, /chat, /health
end note

@enduml
