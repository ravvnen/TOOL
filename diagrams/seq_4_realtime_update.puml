@startuml Sequence_RealtimeUpdate
title Sequence Diagram: Rule Update Flow (Current vs Planned SSE)

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

note as N1
  **Current State:** User must manually refresh to see updates
  **Planned (H4):** SSE push notifications for real-time freshness
end note

actor "User" as USER
participant "Agent.UI" as UI
participant "TOOL API" as API
queue "EVENTS" as EVENTS
participant "Promoter" as PROMOTER
queue "DELTAS" as DELTAS
participant "Delta\nProjector" as PROJECTOR
database "SQLite" as DB

== User Updates Rule via Admin CRUD ==

USER -> UI: Edit rule in Admin tab\nClick "Save"
activate UI

UI -> API: PUT /api/v1/admin/rules/{id}\n{title, content, reason}
activate API

API -> EVENTS: Publish EVENT\n{type: "Admin.RuleEditRequested"}
EVENTS --> API: ACK

API --> UI: 202 Accepted\n{eventId, subject}
deactivate API

UI --> USER: "Rule update submitted"
deactivate UI

== Async Processing (Background) ==

EVENTS -> PROMOTER: EVENT
activate PROMOTER
PROMOTER -> DELTAS: DELTA {type: "im.upsert.v1", new_version}
deactivate PROMOTER

DELTAS -> PROJECTOR: DELTA
activate PROJECTOR
PROJECTOR -> DB: UPSERT im_items_current\n(version++, content)
PROJECTOR -> DB: UPDATE im_fts
deactivate PROJECTOR

note over DB: Rule is updated in DB\nbut UI doesn't know yet

== Current: Manual Refresh Required ==

USER -> UI: Click "Refresh" or\nswitch tabs
activate UI

UI -> API: GET /api/v1/state
API -> DB: Query state
DB --> API: {activeItems, imHash}
API --> UI: StateResponse

UI --> USER: Shows updated rule
deactivate UI

== PLANNED: SSE Push (H4 Freshness) ==

note over PROJECTOR, UI #LightYellow
  **Future Implementation:**

  1. Projector emits SSE event after DB update
  2. Agent.UI subscribes to /api/v1/sse/rules
  3. UI receives push: {event: "rule.updated", id, version}
  4. UI auto-refreshes affected views

  **Freshness Metric:**
  Latency = t(UI displays) - t(Admin clicks Save)
  Target: < 500ms
end note

@enduml
