@startuml Sequence_RuleIngestion
title Sequence Diagram: Rule Ingestion via GitHub Webhook

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

actor "GitHub" as GH
participant "TOOL API\n(SeedController)" as API
participant "SeedHandler" as HANDLER
queue "EVENTS\n(JetStream)" as EVENTS
participant "Promoter\nService" as PROMOTER
queue "DELTAS\n(JetStream)" as DELTAS
participant "Delta\nProjector" as PROJECTOR
database "SQLite" as DB

== GitHub Push Event ==

GH -> API: POST /api/v1/seed\nHeaders: X-GitHub-Delivery, X-GitHub-Event\nBody: {repository, commits, ...}
activate API

API -> HANDLER: HandleAsync(dto, raw, deliveryId)
activate HANDLER

HANDLER -> HANDLER: Parse payload\nExtract rule changes from commits

HANDLER -> EVENTS: Publish EVENT\n{type: "Seed.RuleProposed",\nns, item_id, title, content, source}
activate EVENTS
EVENTS --> HANDLER: ACK (stream: EVENTS, seq: 42)
deactivate EVENTS

HANDLER --> API: {subject: "evt.seed.ravvnen.consulting..."}
deactivate HANDLER

API --> GH: 200 OK {subject: "..."}
deactivate API

== Async: Promoter Processing ==

EVENTS -> PROMOTER: Deliver EVENT (seq: 42)
activate PROMOTER

PROMOTER -> PROMOTER: Validate event type\nCheck schema\nApply gating logic

alt Valid Event
    PROMOTER -> DELTAS: Publish DELTA\n{type: "im.upsert.v1",\nns, item_id, new_version, content}
    activate DELTAS
    DELTAS --> PROMOTER: ACK (stream: DELTAS, seq: 108)
    deactivate DELTAS
else Invalid/Filtered
    PROMOTER -> PROMOTER: Log rejection
    note right: No DELTA emitted
end

PROMOTER -> EVENTS: ACK EVENT
deactivate PROMOTER

== Async: Projection Update ==

DELTAS -> PROJECTOR: Deliver DELTA (seq: 108)
activate PROJECTOR

PROJECTOR -> DB: UPSERT im_items_current\n(ns, item_id, version, content)
PROJECTOR -> DB: INSERT im_items_history
PROJECTOR -> DB: INSERT source_bindings\n(repo, ref, path, blob_sha)
PROJECTOR -> DB: UPDATE im_fts (FTS5)

PROJECTOR -> DELTAS: ACK DELTA
deactivate PROJECTOR

note over DB: Rule is now searchable\nvia FTS5 and queryable\nvia Memory Compiler

@enduml
